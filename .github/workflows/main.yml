name: Chimera CI & Governance Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup Python environment
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Install uv (fast dependency manager)
      - name: Install uv
        run: pip install uv

      # Install project dependencies
      - name: Install dependencies
        run: uv sync --frozen

      # Run tests (they should fail for TDD – that's expected)
      - name: Run failing TDD tests
        run: make test || echo "Tests failed as expected (TDD placeholders)"

      # Basic spec alignment check
      - name: Check for spec references
        run: |
          if grep -r -q "specs/" . ; then
            echo "OK: Code references specs folder"
          else
            echo "WARNING: No references to specs/ found – potential spec drift"
            exit 1
          fi

      # Optional: Lint (black) – uncomment if you added black to dev deps
      # - name: Lint with black
      #   run: uv run black --check .

      # Optional: Security scan (bandit) – uncomment if you added bandit
      # - name: Security scan
      #   run: uv run bandit -r .

  notify-on-failure:
    if: failure()
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Notify failure (optional – can be Slack/email)
        run: echo "CI failed – check GitHub Actions logs"